// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

enum UserRole {
  ADMIN
  USER
}

model User {
  id               String                 @id @default(cuid())
  name             String?
  email            String?                @unique
  emailVerified    DateTime?              @map("email_verified")
  image            String?
  password         String?
  activeCourseId   Int?
  activeCourse     Course?                @relation(fields: [activeCourseId], references: [id])
  nativeLanguage   String?                @default("English")
  interests        String[]               @default([])
  role             UserRole               @default(USER)
  accounts         Account[]
  subscriptions    Course[]               @relation("UserSubscriptions")
  progress         UserProgress[]
  exerciseProgress UserExerciseProgress[]
  dictionaries     UserDictionary[]

  @@map("users")
}

model VerificationToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime

  @@unique([email, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime

  @@unique([email, token])
}

model Language {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  code      String   @unique
  createdAt DateTime @default(now())
  courses   Course[]

  fromWords Word[] @relation("LanguageFrom")
  toWords   Word[] @relation("LanguageTo")
}

model Level {
  id      Int      @id @default(autoincrement())
  name    String   @unique
  courses Course[]
}

model Course {
  id           Int              @id @default(autoincrement())
  language     Language         @relation(fields: [languageId], references: [id])
  languageId   Int
  level        Level            @relation(fields: [levelId], references: [id])
  levelId      Int
  texts        Text[]
  subscribers  User[]           @relation("UserSubscriptions")
  dictionaries UserDictionary[] // Dictionaries specific to this course
  User         User[]

  @@unique([languageId, levelId])
}

model Text {
  id              Int                  @id @default(autoincrement())
  title           String
  content         String
  course          Course               @relation(fields: [courseId], references: [id])
  courseId        Int
  picture_url     String?
  picture_data    Bytes? // Stored image binary data (DALL-E images are temporary URLs)
  audio_url       String?
  exercises       Exercise[]
  progress        UserProgress[] // User progress for this text
  wordAppearances WordTextAppearance[] // Tracks which dictionary words appeared in this text
}

enum ExerciseType {
  MULTIPLE_CHOICE
  FILL_BLANK
  TRUE_FALSE
  TRANSLATION
  SENTENCE_ORDER
}

model Exercise {
  id            Int                    @id @default(autoincrement())
  type          ExerciseType
  question      String                 // The question or prompt
  options       String?                // JSON array of options (for multiple choice, sentence order)
  correctAnswer String                 // The correct answer (or JSON for complex answers)
  explanation   String?                // Explanation of the correct answer
  content       String                 // Legacy field / additional context
  text          Text                   @relation(fields: [textId], references: [id], onDelete: Cascade)
  textId        Int
  orderIndex    Int                    @default(0) // Display order within the text
  progress      UserExerciseProgress[] // User progress for this exercise
}

// Tracks user-specific progress on each text
model UserProgress {
  id      Int     @id @default(autoincrement())
  user    User    @relation(fields: [userId], references: [id])
  userId  String
  text    Text    @relation(fields: [textId], references: [id])
  textId  Int
  seen    Boolean @default(false)
  current Boolean @default(false)

  @@unique([userId, textId])
}

// Tracks user-specific completion of each exercise
model UserExerciseProgress {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  exerciseId Int
  completed  Boolean  @default(false)
  correct    Boolean? // Whether the answer was correct
  userAnswer String?  // What the user answered
  attempts   Int      @default(0) // Number of attempts
  answeredAt DateTime? // When the user last answered

  @@unique([userId, exerciseId])
}

// Represents a user's dictionary for a specific course
model UserDictionary {
  id       Int    @id @default(autoincrement())
  user     User   @relation(fields: [userId], references: [id])
  userId   String
  course   Course @relation(fields: [courseId], references: [id])
  courseId Int
  words    Word[] // Words in the dictionary

  @@unique([userId, courseId]) // Ensures a unique dictionary per user-course pair
}

enum MasteryLevel {
  LEARNING // User just learned this word
  REVIEWING // User is reinforcing this word
  MASTERED // User has mastered this word
}

// Represents a word and its translation in a user's dictionary
model Word {
  id                  Int                  @id @default(autoincrement())
  original            String // The original word
  translation         String // The translation of the word
  languageFrom        Language             @relation("LanguageFrom", fields: [fromLanguageId], references: [id])
  fromLanguageId      Int // The language of the original word
  languageTo          Language             @relation("LanguageTo", fields: [toLanguageId], references: [id])
  toLanguageId        Int // The language of the translation
  lookupCount         Int                  @default(0) // How many times user looked up this word
  lastSeenAt          DateTime             @default(now()) // When word last appeared in a text
  masteryLevel        MasteryLevel         @default(LEARNING) // Current mastery status
  consecutiveNoClicks Int                  @default(0) // Texts in a row where user didn't click this word
  createdAt           DateTime             @default(now())

  dictionary   UserDictionary       @relation(fields: [dictionaryId], references: [id])
  dictionaryId Int
  appearances  WordTextAppearance[] // Tracks appearances of this word in texts
}

// Tracks when dictionary words appear in generated texts and whether user clicked them
model WordTextAppearance {
  id        Int      @id @default(autoincrement())
  word      Word     @relation(fields: [wordId], references: [id], onDelete: Cascade)
  wordId    Int
  text      Text     @relation(fields: [textId], references: [id], onDelete: Cascade)
  textId    Int
  clicked   Boolean  @default(false) // Did user click this word in this text?
  createdAt DateTime @default(now())

  @@unique([wordId, textId])
}
